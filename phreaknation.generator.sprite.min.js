module.exports=function(){"use strict";var config,__modulename="sprite_generator",__version=[0,0,1],__description="Generate sprites via a back end, as well as saving them via the Registry Plugin via Base64 and cache.",__author="Joel Dies <phreaknation@gmail.com>",$={fs:require("fs"),path:require("path"),url:require("url"),_:require("lodash"),Canvas:require("canvas"),crypto:require("crypto")},filters={},module=function(configFile){this.config={filters:{},folders:{filters:$.path.join(process.cwd(),"./src/js/Sprite Generator/filter"),cache:"/assets/images/cache/",src:$.path.join(process.cwd(),"src/images/"),output:$.path.join(process.cwd(),"public/assets/images/cache/"),www:$.path.join(process.cwd(),"/public/")}},$._.isString(configFile)&&$.fs.existsSync(configFile)&&(this.config=require(configFile));var dirFilters=this.config.folders.filters;if($._.isString(dirFilters)&&$.fs.existsSync(dirFilters)){var files=$.fs.readdirSync(dirFilters);$._.each(files,function(file){var name=file.split(".").slice(0,-1).join(".");filters[name]=require($.path.join(dirFilters,file)),console.log("Loaded Filter `%s`",name)})}return config=this.config,this},Cache=function(opts){return this._opts=opts,this};module.prototype.Cache=Cache,Cache.prototype.getImagePath=function(hash){var imagePath=$.path.join(config.folders.src,this._opts.type,this._opts.name,"cache",hash+".png");return imagePath};var Layer=function(height,width){return this._canvas=new $.Canvas(width,height),this.ctx=this._canvas.getContext("2d"),this.height=height,this.width=width,this};module.prototype.Layer=Layer,Layer.prototype.crop=function(x,y,width,height,apply){apply=apply||!1;var canvas=new $.Canvas(this.config.details.width,this.config.details.height),ctx=this._canvas.getContext("2d");return this.canvas.width=width,this.canvas.height=height,ctx.drawImage(this._canvas,x,y,width,height,0,0,this._canvas.width,this._canvas.height),apply?(this._canvas=canvas,this._ctx=ctx,this):canvas},Layer.prototype.getCanvas=function(){return this._canvas},Layer.prototype.loadImage=function(file,hash,callback){var imgSize=$.sizeOf(file),canvas=new $.Canvas(imgSize.width,imgSize.height),ctx=canvas.getContext("2d"),i=new $.Canvas.Image;i.src=$.fs.readFileSync(file),ctx.drawImage(i,0,0,i.width,i.height),callback&&callback(canvas,hash)},Layer.prototype.shiftHue=function(hex,mode,dimensions,position){mode=mode||"overlay",position=position||{x:0,y:0};for(var imgData=this.ctx.getImageData(position.x,position.y,dimensions.width,dimensions.height),dataArray=imgData.data,i=0;i<dataArray.length;i+=4){var red=dataArray[i],green=dataArray[i+1],blue=dataArray[i+2],alpha=dataArray[i+3];if(0!==alpha){var r=parseInt(hex.substr(0,2),16),g=parseInt(hex.substr(2,2),16),b=parseInt(hex.substr(4,2),16);switch(mode){case"multiply":dataArray[i]=red*r/255,dataArray[i+1]=green*g/255,dataArray[i+2]=blue*b/255,dataArray[i+3]=alpha;break;case"overlay":dataArray[i]=r<128?2*red*r/255:255-2*(255-red)*(255-r)/255,dataArray[i+1]=g<128?2*green*g/255:255-2*(255-green)*(255-g)/255,dataArray[i+2]=b<128?2*blue*b/255:255-2*(255-blue)*(255-b)/255,dataArray[i+3]=alpha;break;default:dataArray[i]=red,dataArray[i+1]=green,dataArray[i+2]=blue,dataArray[i+3]=alpha}}}return imgData};var Sprite=function(opts,hash){if(this._opts=opts,this._srcFolder=$.path.join(config.folders.src,opts.type,opts.name),this._hash=hash,this._hashfile=$.path.join(config.folders.output,hash+".png"),this._config=require(this._srcFolder+"/sprite.json"),this._canvas=new $.Canvas(this._config.details.width,this._config.details.height),this.ctx=this._canvas.getContext("2d"),$.fs.existsSync($.path.join(config.folders.www,config.folders.cache))||$.fs.mkdirSync($.path.join(config.folders.www,config.folders.cache)),this.parent=module,this.type=opts.type,this.name=opts.name,this.hash=hash,this.isLoaded=!1,"true"===this._opts.force)return this;if($.fs.existsSync(this._hashfile)){var i=this.loadImage(this._hashfile);this.ctx.drawImage(i,0,0,this._config.details.width,this._config.details.height),this.isLoaded=!0}return this};return module.prototype.Sprite=Sprite,Sprite.prototype.getBase64Image=function(opts,img){return this._canvas.toDataURL()},Sprite.prototype.getImagePath=function(){return this._hashfile},Sprite.prototype.getImageURL=function(){return config.folders.cache+this._hash+".png"},Sprite.prototype.loadImage=function(file){var spritesheet=new $.Canvas.Image;return $._.isUndefined(file)||(spritesheet.src=$.fs.readFileSync(file)),spritesheet},Sprite.prototype.mergeLayers=function(bottomImageCTX,topImageCTX){for(var bottomImageData=bottomImageCTX.getImageData(0,0,this._canvas.width,this._canvas.height),topImageData=topImageCTX.getImageData(0,0,this._canvas.width,this._canvas.height),bottomDataArray=bottomImageData.data,topDataArray=topImageData.data,i=0;i<bottomDataArray.length;i+=4){var bottomLayer={red:bottomDataArray[i],green:bottomDataArray[i+1],blue:bottomDataArray[i+2],alpha:bottomDataArray[i+3]},topLayer={red:topDataArray[i],green:topDataArray[i+1],blue:topDataArray[i+2],alpha:topDataArray[i+3]};0!==topLayer.alpha&&(bottomLayer.alpha=255-(255-topLayer.aplha)*(255-bottomLayer.alpha),bottomDataArray[i]=Math.round(topLayer.red*topLayer.alpha/bottomLayer.alpha+bottomLayer.red*bottomLayer.aplha*(1-topLayer.alpha)/bottomLayer.alpha),bottomDataArray[i+1]=Math.round(topLayer.green*topLayer.alpha/bottomLayer.alpha+bottomLayer.green*bottomLayer.aplha*(1-topLayer.alpha)/bottomLayer.alpha),bottomDataArray[i+2]=Math.round(topLayer.blue*topLayer.alpha/bottomLayer.alpha+bottomLayer.blue*bottomLayer.aplha*(1-topLayer.alpha)/bottomLayer.alpha),bottomDataArray[i]=topLayer.red,bottomDataArray[i+1]=topLayer.green,bottomDataArray[i+2]=topLayer.blue,bottomDataArray[i+3]=topLayer.alpha)}return bottomImageData},Sprite.prototype.processLayers=function(){var layer,sprite=this,_spritesheet=sprite.loadImage($.path.join(sprite._srcFolder,"spritesheet.png"));return $._.each(sprite._config.spritesheet,function(spritesheet,index){var _filters={visible:!0};if($._.isUndefined(layer)&&(layer=new Layer(spritesheet.height,spritesheet.width)),!$._.isUndefined(sprite._opts.layers[index])){var layerOptions={};$._.each(sprite._opts.layers[index].split("|"),function(value,filter){var f=value.split("::");layerOptions[f[0]]=f[1]}),_filters=$._.extend(_filters,layerOptions)}if($._.isBoolean(_filters.visible)&&_filters.visible===!0||$._.isString(_filters.visible)&&"true"===$._.toLower(_filters.visible)){var filterLayer=new Layer(spritesheet.height,spritesheet.width);filterLayer.ctx.drawImage(_spritesheet,spritesheet.x,spritesheet.y,spritesheet.width,spritesheet.height,0,0,spritesheet.width,spritesheet.height);var flatData;$._.each(_filters,function(value,filter){"visible"!==filter&&$._.isFunction(filters[filter])&&(flatData=filters[filter](filterLayer,value))}),$._.isUndefined(flatData)?layer.ctx.drawImage(filterLayer.getCanvas(),0,0):layer.ctx.putImageData(flatData.ctx.getImageData(0,0,flatData.width,flatData.height),0,0)}}.bind(sprite)),console.log(layer),sprite.ctx.drawImage(layer.getCanvas(),0,0),sprite},Sprite.prototype.save=function(callback){var __funcname="save",fileOutput=$.fs.createWriteStream(this._hashfile),stream=this._canvas.pngStream();stream.on("data",function(chunk){this.write(chunk)}.bind(fileOutput)),stream.on("end",function(callback){$._.isFunction(callback)&&callback(this),console.log("[%s][%s] Generated Sprite `%s`.",__modulename,__funcname,this._hash)}.bind(this,callback))},module.prototype.description=function(){return $._.capitalize($._.replace(__modulename,/\_/g," "))+" module by "+__author+". "+__description},module.prototype.version=function(){return __version.join(".")},module.prototype.buildImage=function(opts,hash,callback){$.path.join(config.folders.src,opts.type,opts.name);return this.ctx},module.prototype.encrypt=function(preHash){return $.crypto.createHash("md5").update(preHash).digest("hex")},module.prototype.getOptions=function(params,query){var __funcname="getOptions",opts={layers:{}};if(!$._.isString(params.type))throw Error("["+__modulename+"]["+__funcname+"] Type is either undefined or not a string.");if(!$._.isString(params.name))throw Error("["+__modulename+"]["+__funcname+"] Name is either undefined or not a string.");return opts.layers=$._.extend(opts.layers,query),$._.isUndefined(opts.layers._force)||(opts.force=opts.layers._force,delete opts.layers._force),opts.type=params.type,opts.name=params.name,opts},module}();
